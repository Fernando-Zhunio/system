<div class="mt-3 section-order">
  <div class="center justify-content-between flex-wrap">
    <h3 class="font-3xl font-weight-bold m-0">Envíos</h3>
    <ng-container *ngxPermissionsOnly="permissionsShipping.create">
      <button
        *ngIf="!isCancelled"
        color="accent"
        class="mb-1"
        mat-raised-button
        (click)="openDialogShipping()"
      >
        Agregar envío <mat-icon>add </mat-icon>
      </button>
    </ng-container>
  </div>
  <hr />
  <div class="row">
    <div class="col-md-4 p-2" *ngFor="let shipping of shippings">
      <mat-card class="border-0 " [ngClass]="{'bg-ro-fz': shipping.is_return}" >
        <div class="d-flex justify-content-between">
          <span [class]="shipping.type">{{ shipping.type }}</span>
          <small *ngIf="shipping.is_return" class="bg-danger p-1 px-2 rounded-pill shadow">Guía de retorno</small>
        </div>
        <div>
          <div
            class="badge font-sm {{ shipping.status }}"
            *ngIf="
              shipping.type != 'pickup' ||
                shipping.status == 'delivered' ||
                shipping.status == 'cancelled';
              else templateSelectStatus
            "
          >
            <span
              >Estado:
              <ng-container
                *ngIf="
                  shipping.status == 'shipped' && shipping.type == 'pickup';
                  else elseTemplateCustomShippedStatus
                "
                >Listo para recoger</ng-container
              >
              <ng-template #elseTemplateCustomShippedStatus>{{
                shipping.status | translatefz: "orders"
              }}</ng-template>
            </span>
          </div>
          <!-- <div *ngIf="shipping.status == 'generated_guide'">
            <button mat-button color="warn"  (click)="changeStatusShipping('processed', shipping.id)">Cambiar estado a procesado</button>
          </div> -->
          <ng-template #templateSelectStatus>
            <div
              *ngxPermissionsOnly="
                permissionsShipping.edit;
                else elseStatePermission;
                then: thenStatePermission
              "
            ></div>
            <ng-template #thenStatePermission>
              <div class="d-flex">
                <mat-form-field>
                  <mat-select
                    [disabled]="isCancelled"
                    [value]="shipping.status"
                    (selectionChange)="
                      changeStatusShipping($event, shipping.id)
                    "
                    placeholder="Cambio de estado"
                  >
                    <mat-option value="pending">Pendiente</mat-option>
                    <mat-option value="processed">Listo para recoger</mat-option>
                    <!-- <mat-option value="shipped">Enviado</mat-option> -->
                    <mat-option value="delivered">Entregado</mat-option>
                    <mat-option value="cancelled">Cancelado</mat-option>
                  </mat-select>
                </mat-form-field>
              </div>
            </ng-template>
            <ng-template #elseStatePermission>
              <div class="d-flex">
                <span class="badge font-sm {{ shipping.status }}"
                  >Estado: {{ shipping.status | translatefz: "orders" }}</span
                >
              </div>
            </ng-template>
          </ng-template>
          <table class="table table-sm table-borderless">
            <tbody class="body-info">
              <tr>
                <td>Creado:</td>
                <td>{{ shipping.created_at | date }}</td>
              </tr>
              <tr>
                <td>Monto:</td>
                <td>$ {{ shipping.amount }}</td>
              </tr>
              <tr>
                <td>Peso cubico:</td>
                <td>{{ shipping?.cubicweight }}</td>
              </tr>
              <tr>
                <td>Peso:</td>
                <td>{{ shipping?.weight }}</td>
              </tr>
              <tr>
                <td>Altura:</td>
                <td>{{ shipping?.height }}</td>
              </tr>
              <tr>
                <td>Ancho:</td>
                <td>{{ shipping?.width }}</td>
              </tr>
              <tr>
                <td>Longitud:</td>
                <td>{{ shipping?.length }}</td>
              </tr>
              <tr>
                <td>Bodegas:</td>
                <td class="center justify-content-start">
                  <span class="badge bg-success">{{
                    shipping?.origin_warehouse?.code
                  }}</span
                  >{{ shipping?.origin_warehouse?.name }}
                </td>
              </tr>
              <tr>
                <td># Tracking</td>
                <td>{{ shipping.tracking_number | nullFz }}</td>
              </tr>
              <tr *ngIf="shipping.tracking_link">
                <td>Tracking Link</td>
                <td>
                  <a
                    style="word-break: break-all"
                    target="_blank"
                    [href]="shipping.tracking_link"
                    >{{ shipping.tracking_link }}</a
                  >
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <div *ngIf="!isCancelled">
          <div class="d-flex justify-content-between">
            <div>
              <button
                color="info"
                mat-raised-button
                *ngxPermissionsOnly="permissionsShipping.edit"
                (click)="
                  openDialogProductsShipping(shipping.id, shipping.status)
                "
              >
                <mat-icon>category</mat-icon> Productos
              </button>
              <ng-container
                *ngIf="
                  shipping.status != 'delivered' &&
                  !shipping.tracking_number &&
                  shipping.status != 'cancelled'
                "
              >
                <button
                  *ngxPermissionsOnly="permissionsShipping.edit"
                  mat-icon-button
                  color="primary"
                  (click)="openDialogShipping(shipping.id)"
                >
                  <mat-icon>edit</mat-icon>
                </button>
                <ng-container *ngxPermissionsOnly="permissionsShipping.destroy">
                  <button
                    mat-icon-button
                    color="warn"
                    *ngIf="!shipping.tracking_number"
                    (click)="deleteShipping(shipping.id)"
                  >
                    <mat-icon>delete</mat-icon>
                  </button>
                </ng-container>
              </ng-container>
            </div>
            <button mat-icon-button [matMenuTriggerFor]="menuRef">
              <mat-icon>more_vert</mat-icon>
            </button>
          </div>
          <mat-menu #menuRef="matMenu">
            <button
              (click)="openDialogHistoryStatus(shipping.id)"
              mat-menu-item
            >
              <mat-icon>manage_search</mat-icon>
              <span>Ver Historial</span>
            </button>

            <button *ngIf="shipping.status == 'servientrega'" mat-menu-item (click)="returnShipping(shipping.id)">
              <mat-icon>rv_hookup</mat-icon>
              <span>Retornar envío</span>
            </button>
            <ng-container *ngIf="shipping.type == 'servientrega'">
              <ng-container *ngxPermissionsOnly="permissionsShipping.send">
                <button
                  *ngIf="!shipping.tracking_number; else templateDeleteGuie"
                  mat-menu-item
                  (click)="openGenerateGuide(shipping.id)"
                >
                  <mat-icon>grading</mat-icon>
                  <span>Generar guía</span>
                </button>
              </ng-container>
              <ng-template #templateDeleteGuie>
                <button mat-menu-item (click)="deleteGuie(shipping.id)">
                  <mat-icon>delete</mat-icon>
                  <span>Eliminar guía</span>
                </button>

                <button mat-menu-item (click)="openViewPdf(shipping.id)">
                  <mat-icon>picture_as_pdf</mat-icon>
                  <span>Ver PDF</span>
                </button>
              </ng-template>
            </ng-container>
          </mat-menu>
        </div>
      </mat-card>
    </div>
  </div>
</div>

<div
  *ngIf="isOpenCv"
  [ngClass]="isOpenCv ? 'open-cv' : 'close-cv'"
  class="section-cv"
>
  <div class="content-cv">
    <button
      class="btn-close-cv bg-dark"
      (click)="isOpenCv = false"
      mat-mini-fab
    >
      <mat-icon>close</mat-icon>
    </button>
    <div class="container-cv shadow p-3">
      <div class="row h-100">
        <div class="col-md-12">
          <div class="display-4 h-100">
            <iframe width="100%" height="100%" [src]="encoded_pdf"></iframe>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
