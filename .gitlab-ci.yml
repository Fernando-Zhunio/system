# docker image
image: getterminus/angular-ci-images:node14

.init_ssh: &init_ssh |
  eval $(ssh-agent -s)
  echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add - > /dev/null
  mkdir -p ~/.ssh
  chmod 700 ~/.ssh
  [[ -f /.dockerenv ]] && echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config

stages:
  - dependencies
  - test
  - build
  - deploy

npm:
  stage: dependencies
  cache:
    paths:
      - node_modules/
  script:
      - cp ./src/environments/environment.staging.ts  ./src/environments/environment.ts 
      - apt-get install git
      - npm install
  artifacts:
    expire_in: 1 month
    paths:
      - node_modules/
      - ./src/environments/environment.ts

jasmine:
  stage: test
  dependencies:
    - npm
  script:
    - cp karma.staging.conf.js  karma.conf.js
    - npm i -g @angular/cli
    - npm test
    

# staging_build:
#   stage: build
#   cache:
#     paths:
#       - dist/
#   script:
    
#     - npm
#   artifacts:
#     expire_in: 1 month
#     paths:
#       - node_modules/
#       - dist/

#   only:
#     - master

# production_build:
#   stage: build
#   cache:
#     paths:
#       - dist/
#   script:
    
#   dependencies:
#     - npm
#   artifacts:
#     expire_in: 1 month
#     paths:
#       - node_modules/
#       - dist/
#   only:
#     - master

staging:
  stage: deploy
  script:
    - *init_ssh
    # - cp ./src/environments/environment.staging.ts  ./src/environments/environment.ts 
    - npm i -g @angular/cli
    - ng b --configuration staging
    - apt-get update
    - apt-get install -y zip unzip
    - cd ./dist && zip -r ./app.zip .
    - scp ./app.zip root@104.207.144.7:/var/www/staging-system.novicompu.com/
    - currentDate=`date '+%F %T'`
    - ssh root@104.207.144.7 "cd /var/www/staging-system.novicompu.com/ && mkdir tmp && unzip -o ./app.zip -d  ./tmp/ && mv ./public ./'$currentDate' && mv ./tmp ./public"
  only:
    - master


production:
  stage: deploy
  script:
    - *init_ssh
    - npm i -g @angular/cli
    - ng build --prod
    - apt-get update
    - apt-get install -y zip unzip
    - cd ./dist && zip -r ./app.zip .
    - scp ./app.zip root@104.207.144.7:/var/www/system.novicompu.com/
    - currentDate=`date '+%F %T'`
    - ssh root@104.207.144.7 "cd /var/www/system.novicompu.com/ && mkdir tmp && unzip -o ./app.zip -d  ./tmp/ && mv ./public ./'$currentDate' && mv ./tmp ./public"
  when: manual
  only:
    - master